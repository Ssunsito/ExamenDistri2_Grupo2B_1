@model List<ProyectoDistri2.Models.Reserva>
@{
    ViewBag.Title = "Panel de Administrador";
    var espacios = ViewBag.Espacios as List<ProyectoDistri2.Models.Espacio>;
    var usuarios = ViewBag.Usuarios as List<ProyectoDistri2.Models.Usuario>;
}

<h2>Panel de Administrador</h2>

<ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="reservas-tab" data-bs-toggle="tab" href="#reservas" role="tab">Reservas</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="espacios-tab" data-bs-toggle="tab" href="#espacios" role="tab">Espacios</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="usuarios-tab" data-bs-toggle="tab" href="#usuarios" role="tab">Usuarios</a>
    </li>
</ul>

<div class="tab-content mt-3">

    <!-- 🔹 Reservas -->
    <div class="tab-pane fade show active" id="reservas" role="tabpanel">
        <h4>Gestión de Reservas</h4>
        <table class="table-modern" id="tablaReservas">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Espacio</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model)
                {
                    <tr>
                        <td>@r.Id</td>
                        <td>@(r.Usuario?.Nombre)</td>
                        <td>@(r.Espacio?.Nombre) (@(r.Espacio?.Tipo))</td>
                        <td>@r.FechaInicio.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@r.FechaFin.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@r.Estado</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="abrirEditarReserva(@r.Id)">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarReserva(@r.Id)">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 🔹 Espacios -->
    <div class="tab-pane fade" id="espacios" role="tabpanel">
        <h4>Gestión de Espacios</h4>
        <button class="btn btn-primary mb-2" onclick="abrirCrearEspacio()">Crear Nuevo Espacio</button>
        <table class="table-modern" id="tablaEspacios">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in espacios)
                {
                    <tr>
                        <td>@e.Id</td>
                        <td>@e.Nombre</td>
                        <td>@e.Tipo</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="abrirEditarEspacio(@e.Id, '@e.Nombre', '@e.Tipo')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEspacio(@e.Id)">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 🔹 Usuarios -->
    <div class="tab-pane fade" id="usuarios" role="tabpanel">
        <h4>Gestión de Usuarios</h4>
        <button class="btn btn-primary mb-2" onclick="abrirCrearUsuario()">Crear Usuario</button>
        <table class="table-modern" id="tablaUsuarios">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in usuarios)
                {
                    <tr>
                        <td>@u.Id</td>
                        <td>@u.Nombre</td>
                        <td>@u.Rol</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="abrirEditarUsuario(@u.Id, '@u.Nombre', '@u.Rol')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarUsuario(@u.Id)">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 🔹 Modal genérico para Crear/Editar -->
<div class="modal fade" id="modalCrud" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Aquí se inyectará el formulario dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarModal">Guardar</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    const token = '@Session["Token"]';

    // 🔹 Funciones genéricas para abrir modales
    function abrirCrearEspacio() {
        $("#modalTitle").text("Crear Nuevo Espacio");
        $("#modalBody").html(`
            <input type="hidden" id="espacioId" value="0"/>
            <div class="mb-3"><label>Nombre</label><input class="form-control" id="espacioNombre"/></div>
            <div class="mb-3"><label>Tipo</label><input class="form-control" id="espacioTipo"/></div>
        `);
        $("#btnGuardarModal").off("click").on("click", guardarEspacio);
        new bootstrap.Modal(document.getElementById('modalCrud')).show();
    }

    function abrirEditarEspacio(id, nombre, tipo) {
        $("#modalTitle").text("Editar Espacio");
        $("#modalBody").html(`
            <input type="hidden" id="espacioId" value="${id}"/>
            <div class="mb-3"><label>Nombre</label><input class="form-control" id="espacioNombre" value="${nombre}"/></div>
            <div class="mb-3"><label>Tipo</label><input class="form-control" id="espacioTipo" value="${tipo}"/></div>
        `);
        $("#btnGuardarModal").off("click").on("click", guardarEspacio);
        new bootstrap.Modal(document.getElementById('modalCrud')).show();
    }

    function guardarEspacio() {
        const id = $("#espacioId").val();
        const data = { Id: id, Nombre: $("#espacioNombre").val(), Tipo: $("#espacioTipo").val() };
        const method = id == 0 ? "POST" : "PUT";
        const url = 'https://localhost:44398/api/espacios' + (id == 0 ? "" : "/" + id);

        $.ajax({
            url: url,
            type: method,
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { Authorization: "Bearer " + token },
            success: function () { location.reload(); },
            error: function () { alert("Error al guardar espacio"); }
        });
    }

    function eliminarEspacio(id) {
        if (!confirm("¿Seguro que deseas eliminar este espacio?")) return;
        $.ajax({
            url: 'https://localhost:44398/api/espacios/' + id,
            type: 'DELETE',
            headers: { Authorization: "Bearer " + token },
            success: function () { location.reload(); },
            error: function () { alert("Error al eliminar espacio"); }
        });
    }

    // 🔹 Usuarios: Crear/Editar similar
    function abrirCrearUsuario() {
        $("#modalTitle").text("Crear Usuario");
        $("#modalBody").html(`
            <input type="hidden" id="usuarioId" value="0"/>
            <div class="mb-3"><label>Nombre</label><input class="form-control" id="usuarioNombre"/></div>
            <div class="mb-3"><label>Rol</label><select class="form-control" id="usuarioRol">
                <option>Profesor</option>
                <option>Coordinador</option>
                <option>Admin</option>
            </select></div>
            <div class="mb-3"><label>Password</label><input class="form-control" id="usuarioPassword" type="password"/></div>
        `);
        $("#btnGuardarModal").off("click").on("click", guardarUsuario);
        new bootstrap.Modal(document.getElementById('modalCrud')).show();
    }

    function abrirEditarUsuario(id, nombre, rol) {
        $("#modalTitle").text("Editar Usuario");
        $("#modalBody").html(`
            <input type="hidden" id="usuarioId" value="${id}"/>
            <div class="mb-3"><label>Nombre</label><input class="form-control" id="usuarioNombre" value="${nombre}"/></div>
            <div class="mb-3"><label>Rol</label><select class="form-control" id="usuarioRol">
                <option ${rol=="Profesor"?"selected":""}>Profesor</option>
                <option ${rol=="Coordinador"?"selected":""}>Coordinador</option>
                <option ${rol=="Admin"?"selected":""}>Admin</option>
            </select></div>
            <div class="mb-3"><label>Password</label><input class="form-control" id="usuarioPassword" type="password"/></div>
        `);
        $("#btnGuardarModal").off("click").on("click", guardarUsuario);
        new bootstrap.Modal(document.getElementById('modalCrud')).show();
    }

    function guardarUsuario() {
        const id = $("#usuarioId").val();
        const data = { Id: id, Nombre: $("#usuarioNombre").val(), Rol: $("#usuarioRol").val(), Password: $("#usuarioPassword").val() };
        const method = id == 0 ? "POST" : "PUT";
        const url = 'https://localhost:44398/api/usuarios' + (id == 0 ? "" : "/" + id);

        $.ajax({
            url: url,
            type: method,
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { Authorization: "Bearer " + token },
            success: function () { location.reload(); },
            error: function () { alert("Error al guardar usuario"); }
        });
    }

    function eliminarUsuario(id) {
        if (!confirm("¿Seguro que deseas eliminar este usuario?")) return;
        $.ajax({
            url: 'https://localhost:44398/api/usuarios/' + id,
            type: 'DELETE',
            headers: { Authorization: "Bearer " + token },
            success: function () { location.reload(); },
            error: function () { alert("Error al eliminar usuario"); }
        });
    }

    function abrirEditarReserva(id) {
        // 🔹 Obtener la reserva actual por AJAX
        $.ajax({
            url: 'https://localhost:44398/api/reservas/' + id,
            type: 'GET',
            headers: { Authorization: 'Bearer ' + token },
            success: function (reserva) {
                // Construir el modal dinámico
                $("#modalTitle").text("Editar Reserva #" + reserva.Id);
                $("#modalBody").html(`
            <input type="hidden" id="reservaId" value="${reserva.Id}" />
            <div class="mb-3"><label>Espacio</label>
                <select class="form-control" id="reservaEspacioId">
                    ${generarOpcionesEspacios(reserva.EspacioId)}
                </select>
            </div>
            <div class="mb-3"><label>Fecha Inicio</label>
                <input class="form-control" id="reservaFechaInicio" type="datetime-local" value="${formatearFechaInput(reserva.FechaInicio)}"/>
            </div>
            <div class="mb-3"><label>Fecha Fin</label>
                <input class="form-control" id="reservaFechaFin" type="datetime-local" value="${formatearFechaInput(reserva.FechaFin)}"/>
            </div>
            <div class="mb-3"><label>Estado</label>
                <select class="form-control" id="reservaEstado">
                    <option ${reserva.Estado == "Pendiente" ? "selected" : ""}>Pendiente</option>
                    <option ${reserva.Estado == "Aprobada" ? "selected" : ""}>Aprobada</option>
                    <option ${reserva.Estado == "Rechazada" ? "selected" : ""}>Rechazada</option>
                </select>
            </div>
        `);
                $("#btnGuardarModal").off("click").on("click", guardarReserva);
                new bootstrap.Modal(document.getElementById('modalCrud')).show();
            },
            error: function () { alert("Error al obtener los datos de la reserva."); }
        });

        function guardarReserva() {
            const id = $("#reservaId").val();
            const data = {
                Id: id,
                EspacioId: $("#reservaEspacioId").val(),
                FechaInicio: $("#reservaFechaInicio").val(),
                FechaFin: $("#reservaFechaFin").val(),
                Estado: $("#reservaEstado").val(),
                UsuarioId: 0 // La API mantiene el usuario original
            };

            $.ajax({
                url: 'https://localhost:44398/api/reservas/' + id,
                type: 'PUT',
                data: JSON.stringify(data),
                contentType: "application/json",
                headers: { Authorization: "Bearer " + token },
                success: function () {
                    alert("Reserva actualizada correctamente.");
                    location.reload();
                },
                error: function (xhr) {
                    if (xhr.status === 400) {
                        alert("Error: " + xhr.responseJSON?.detalle ?? "Conflicto de reserva.");
                    } else {
                        alert("Error al actualizar la reserva.");
                    }
                }
            });
        }

    function generarOpcionesEspacios(seleccionadoId) {
        const espacios = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Espacios));
        return espacios.map(e =>
            `<option value="${e.Id}" ${e.Id==seleccionadoId?"selected":""}>${e.Nombre} (${e.Tipo})</option>`
        ).join('');
    }

    function formatearFechaInput(fechaStr) {
        const fecha = new Date(fechaStr);
        const offset = fecha.getTimezoneOffset();
        const fechaLocal = new Date(fecha.getTime() - offset * 60000);
        return fechaLocal.toISOString().slice(0,16);
        }

    }

    </script>
}
@section styles {
    <link rel="stylesheet" href="~/Content/PanelAdmin.css" />
}
